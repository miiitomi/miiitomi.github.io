---
title: プレゼントを公平に配る最適なくじ引きを作ろう！🎁
description: PSアルゴリズムと最適くじ引きアプリのご紹介
slug: assignment
toc: true
date: 2024-12-04
categories:
    - マッチング理論
    - マーケットデザイン
    - アルゴリズム
tags: [マッチング理論, マーケットデザイン, アルゴリズム]
---

本記事は [CyberAgent AI Lab Advent Calendar 2024](https://adventar.org/calendars/10254) 16日目の記事として執筆しております！🎄


## はじめに

メリークリスマス！
サイバーエージェント AI Lab 経済学社会実装チームの[みーとみ](https://x.com/miiitomi)です。  

もうすぐクリスマスということで、イベントで子どもたちにプレゼントを配ったり、パーティでプレゼント交換をする機会のある方もいらっしゃるかもしれません。
プレゼントを配るとき、どのようなルールでどのプレゼントをどの参加者に配るのが最も良いのでしょうか？

本記事では、そのようなプレゼントを配るときに使える良いくじ引きを作成するアルゴリズムと、それを簡単に実行できる自作WEBアプリのご紹介をしたいと思います。

説明はいいから早くそのアプリとやらを触ってみたいという方は[**こちら**](https://miiitomi.github.io/assignment)をどうぞ！
そのアルゴリズムが気になるという方はぜひ以下をご覧ください。


## プレゼント割り当て問題

ここで私たちが考えたい問題は、以下のようなものになります。

>**プレゼント割り当て問題**
> - プレゼントは $P$ 種類あり、$j$ 種類目のプレゼントは $q_j$ 個あります。
> - プレゼントの受け取り手は $R$ 人います。
> - 各受け取り手には、欲しいプレゼントの希望順序があります。
>     - 希望の例：「第$1$希望：プレゼント$3$、第$2$希望：プレゼント$1$、それ以外は希望しない」など。

参加者が納得するようプレゼントを公平に配るには、どのようなルールで配ると良いでしょうか？


## よくある方法

プレゼントが十分な数あり、参加者の希望するプレゼントがバラバラならば、それぞれに好きなものを配れば良いでしょう。
そうでない場合に受け取り手を公平に扱ってプレゼントを配るには、くじ引きなど何らかの方法でランダムに割り当てる必要があります。
このような状況でよく使われている方法がいくつかあります。まずそれらを検討してみましょう。

### 1. プレゼントごとのくじ引き

よくある方法一つ目のくじ引きでは、以下のようなルールでプレゼントを割り当てます。

>**プレゼントごとのくじ引き**
> - 各プレゼントについて$1$種類目から$P$種類目まで順に、以下を行う。
>   - 今配ろうとしているプレゼントは $j$ 種類目とする。
>   - まだプレゼントを貰っていない受け取り手のうち $q_j$ 人までの人を選び、プレゼント $j$ を渡す。
>   - プレゼントを貰っていない人がいなくなったら終了する。そうでなければ次のプレゼントに進む。

このようなくじ引きによるプレゼント配りは広く使われていますし、またイベントにおいてはくじ引きのワクワク感により盛り上がるでしょう。
しかし、参加者の希望を一切考慮せずに割り当てを行なっているため、以下のような不納得感が発生してしまうかもしれません。

>**例 1.**
> - プレゼントは A, B, C, D の$4$種類で、それぞれ$1$つずつあるとする。
> - 参加者は 1, 2, 3, 4 の$4$人で、それぞれの希望は以下の通りとする。
> ||第1希望|第2希望|第3希望|第4希望|
> |:--:|:--:|:--:|:--:|:--:|
> |**1 さん**|A|B|C|D|
> |**2 さん**|A|B|C|D|
> |**3 さん**|B|A|D|C|
> |**4 さん**|B|A|D|C|
> - いまくじ引きによってプレゼントが割り当てられ、結果は以下のようになったとします。
>    - プレゼントA：3 さん
>    - プレゼントB：1 さん
>    - プレゼントC：4 さん
>    - プレゼントD：2 さん
> - このとき、次のように受け取り手に不納得感が残ってしまいます。
>    - 3さんと1さんについて、プレゼントAを貰った3さんはプレゼントBの方が良かったと思っており、プレゼントBを貰った1さんはプレゼントAの方が良かったと思っています。よって、二人の受け取るプレゼントが逆だったら、二人とも嬉しかったはずです。
>    - 4さんと2さんについても同様です。

プレゼントごとのくじ引きでは受け取り手の希望を考慮せずに割り当てを行なっているため、例1のように全員の希望をより叶える余地の残ってしまう非効率な割り当てとなってしまう可能性があります。


### 2. 受け取り手優先順序のくじ引き

次は受け取り手の希望を考慮した、次のようなルールを考えてみます。

>**受け取り手優先順序のくじ引き**
> - $R$人の受け取り手それぞれの優先順序を、第$1$優先から第$R$優先までくじ引きによって決める。
> - 第$1$優先の受け取り手から順に、以下を行う。
>    - 残っているプレゼントのうち希望するものがあれば、そのうち最も希望するプレゼントを貰う。

このルールは、受け取り手の希望を考慮しており一見良さそうに見えます。
全員が受け取れる可能性のあるもののうち最も希望するものを貰っているため、プレゼントごとのくじ引きのように割り当て後に全員の希望をより叶える余地が残ってしまうこともありません。

しかし、事前の「受け取るプレゼントの確率分布」の割り当ての意味では、これも非効率となってしまう状況があります。以下の例を見てみましょう。

>**例 2.**
> - プレゼントと受け取り手、受け取り手の希望は例 1.と同様とします。
> - 例えば受け取り手優先順序が1, 2, 3, 4の順に決まったとすると、割り当ては以下のようになります。
>    - 優先順序1位：1さん - プレゼントA
>    - 優先順序2位：2さん - プレゼントB
>    - 優先順序3位：3さん - プレゼントD
>    - 優先順序4位：4さん - プレゼントC
> - 受け取り手の優先順序の決め方は全部で $4! = 24$ 通りあり、それぞれで決まる割り当てを上のように数えると、各受け取り手が各プレゼントを貰う確率は以下のようになります。
> ||プレゼントA|プレゼントB|プレゼントC|プレゼントD|
> |:--:|:--:|:--:|:--:|:--:|
> |**1**|$5 \over 12$|$1 \over 12$|$5 \over 12$|$1 \over 12$|
> |**2**|$5 \over 12$|$1 \over 12$|$5 \over 12$|$1 \over 12$|
> |**3**|$1 \over 12$|$5 \over 12$|$1 \over 12$|$5 \over 12$|
> |**4**|$1 \over 12$|$5 \over 12$|$1 \over 12$|$5 \over 12$|
>
> - いま、仮に1さんと3さんが「1さんがプレゼントBを得るか、もしくは3さんがプレゼントAを得た場合、1さんと3さんはプレゼントを交換する」という約束をしたとしましょう。このとき、二人の貰うプレゼントの確率分布は以下のように変わります。
> ||プレゼントA|プレゼントB|プレゼントC|プレゼントD|
> |:--:|:--:|:--:|:--:|:--:|
> |**1**|$1 \over 2$|$0$|$5 \over 12$|$1 \over 12$|
> |**3**|$0$|$1 \over 2$|$1 \over 12$|$5 \over 12$|
> - 二人とも第2希望を貰う確率が減って、その分第1希望のプレゼントを貰う確率が上がっており、二人ともこの約束によってより希望が叶えられるようになります。

よって、受け取り手優先順序のくじ引きでは、貰うプレゼントの事前の確率分布の割り当ては、皆の希望をより叶える余地のない効率的な割り当てとはならない可能性があります。


## 最適くじ引き：PSアルゴリズム

貰うプレゼントの事前の確率分布の割り当てが皆の希望をより叶える余地のない効率的なものとなる、公平で最適なくじ引きを作るにはどのようにしたらいいでしょうか？

それは [Bogomolnaia and Moulin (2001)](https://doi.org/10.1006/jeth.2000.2710) によって提案されたPS（probabilistic serial）アルゴリズムによって実現することができます。
PSアルゴリズムでは、受け取り手が希望するプレゼントを貰う割合を少しづつ「食べていく（eating）」という表現を使って、以下のように説明されます。

>**PSアルゴリズム**
> - 最初、各プレゼント $j$ の量は $q_j$ ある。
> - $t = 0$ 秒から $t = 1$ 秒までの $1$ 秒間、各参加者 $i$ は以下を行う。
>     - 今の $t \in [0, 1]$ 秒時点において、残っている量が $0$ より大きいプレゼントのうち最も希望するプレゼントを、秒速 $1$ で食べていく。
>         - （あるプレゼントを複数の人で食べている時は、それぞれが同時に秒速 $1$ でそれを食べる。）
>         - （今食べているプレゼントが $0$ になった瞬間に、残っているプレゼントのうち次に希望するプレゼントを食べ始める。）
> - $1$ 秒間に $i$ さんがプレゼント $j$ を食べた量を $e_{i,j}$ とし、それを $i$ さんがプレゼント $j$ を貰う確率とする。

上の説明ではやや分かりにくいと思うので、例を見てみましょう。

>**例 3.**
> - プレゼントと受け取り手、受け取り手の希望は例 1.と同様とする。
> - PSアルゴリズムを適用すると、以下のようになる。
>     - まず $t =  0$ 秒目、1 さんと 2 さんは A を、3 さんと 4 さんは B を食べ始める。
>     - $t = {1 \over 2}$ 秒後、1 さんと 2 さんはそれぞれ A を $1 \over 2$ ずつ食べて A は無くなり、同時に 3 さんと 4 さんも B を $1\over 2$ ずつ食べて B も無くなる。
>     - 1 さんと 2 さんは C を食べ始め、3 さんと 4 さんは D を食べ始める。
>     - $t = 1$ 時点で、1 さんと 2 さんはそれぞれ C を $1 \over 2$ ずつ食べて C は無くなり、同時に 3 さんと 4 さんも D を $1 \over 2$ ずつ食べて D も無くなる。
> - よって、各受け取り手が貰うプレゼントの確率分布は、以下のようになる。
> ||プレゼントA|プレゼントB|プレゼントC|プレゼントD|
> |:--:|:--:|:--:|:--:|:--:|
> |**1**|$1 \over 2$|$0$|$1 \over 2$|$0$|
> |**2**|$1 \over 2$|$0$|$1 \over 2$|$0$|
> |**3**|$0$|$1 \over 2$|$0$|$1 \over 2$|
> |**4**|$0$|$1 \over 2$|$0$|$1 \over 2$|

PSアルゴリズムによって作られる貰う確率分布の割り当ては、皆の希望をより叶える余地のない効率的なものとなります（詳細は[元論文](https://doi.org/10.1006/jeth.2000.2710)、または日本語では [小島・河田 (2024)](https://www.nippyo.co.jp/shop/book/9362.html) を参照）。

また、PSアルゴリズムが行うのは上記のような受け取り手が貰うプレゼントの確率分布の表を作るところまでですが、[Birkhoff-von-Neumannアルゴリズム](https://en.wikipedia.org/wiki/Birkhoff_algorithm)によって実際にこの表の最適くじ引きのもとでくじを引いてプレゼントの割り当てを決定することができます。


## 最適くじ引きアプリ

PSアルゴリズムおよびBirkhoff-von-Neumannアルゴリズムによる公平な最適なくじ引きは、理論的に良く面白い性質を持っていますが、手作業で実際にこのアルゴリズムを実行するのは簡単ではありません。

そこで私は、このPSアルゴリズム・Birkhoff-von-Neumannアルゴリズムによる最適くじ引きを簡単に実行できる[**こちらのWEBアプリ**](https://miiitomi.github.io/assignment)を作成してみました。
直感的に簡単に使えるように作ったので、興味を持った人はぜひこちらを使ってみてください！


## おわりに

経済学とコンピュータサイエンスの知見を用いて、人と人やものをマッチさせる良い方法を理論的に考える分野に**マッチング理論**という分野があり、それらの理論的考察から実際の市場・制度設計を行う実践的な分野に**マーケットデザイン**と呼ばれる分野があります。
マッチング理論・マーケットデザインの学術的知見は、国内外の多くの分野で近年応用されるようになりました。

サイバーエージェント AI Lab 経済学社会実装チームでもマッチング理論・マーケットデザインの研究・社会実装プロジェクトを行なっており、自治体との保育所利用調整の社会実装プロジェクトについては今回のAI Lab Advent Calendar10日目の[竹浪さんの記事](https://note.com/ryaukwan/n/n888456d98606)でも紹介されています。
本記事やアプリを通して、マッチング理論・マーケットデザインや私たちの取り組みに興味を持っていただける方がいましたら大変嬉しいです。

今年の冬はぜひ最適くじ引きアプリでプレゼント交換をして、素敵なクリスマスをお過ごしください！🤶
